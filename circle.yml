machine:
  ruby:
    version: "2.4"

general:
  branches:
    only:
      - master

dependencies:
  override:
    - curl https://raw.githubusercontent.com/kubernetes/helm/master/scripts/get > get_helm.sh
    - chmod 700 get_helm.sh
    - ./get_helm.sh
    - helm init -c
  cache_directories:
    - ~/.helm
test:
  override:
    - git fetch
    - git config --global user.email "bot@bcaldwell.ca" && git config --global user.name "Benjamin Bot"

    # package all them charts
    - bin/package_all
    - git status
    - git add --all .
    - git commit -m "Package charts '$(git log -1 --pretty=%B)' [ci skip]" || true
    - git push origin master || true

    # Publish the Github Pages Site/helm repo
    - ls -A | grep -v "README.md$\|charts-repo$\|.git$\|CNAME" | xargs rm -rf
    - mv charts-repo/* .
    - rm -rf charts-repo
    - git status || true
    - git add --all . || true
    - git commit -m "Update helm repo '$(git log -1 --pretty=%B)' [ci skip]" || true
    - git push origin HEAD:gh-pages -f || true
    
    # purge cloudflare cache
    - |
      curl -X DELETE "https://api.cloudflare.com/client/v4/zones/${CLOUDFLARE_ZONE_ID}/purge_cache" \
        -H "X-Auth-Email: ${CLOUDFLARE_EMAIL}" \
        -H "X-Auth-Key: ${CLOUDFLARE_API_KEY}" \
        -H "Content-Type: application/json" \
        --data '{"purge_everything":true}'

